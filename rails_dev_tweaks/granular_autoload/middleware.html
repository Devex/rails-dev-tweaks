<!DOCTYPE html><html lang="en"><head><title>rails_dev_tweaks/granular_autoload/middleware</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="rails_dev_tweaks/granular_autoload/middleware"><meta name="groc-project-path" content="lib/rails_dev_tweaks/granular_autoload/middleware.rb"><meta name="groc-github-url" content="https://github.com/wavii/rails-dev-tweaks"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>Here's an idea, let's not reload the entire dev environment for each asset request.  Let's only do that on regular
content requests.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nc">RailsDevTweaks</span><span class="o">::</span><span class="no">GranularAutoload</span><span class="o">::</span><span class="no">Middleware</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't cleanup before the very first request</p></div></div><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">attr_writer</span> <span class="ss">:processed_a_request</span>
    <span class="k">def</span> <span class="nf">processed_a_request?</span>
      <span class="vi">@processed_a_request</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">dup</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reload, or no?</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dev_tweaks</span><span class="o">.</span><span class="n">granular_autoload_config</span><span class="o">.</span><span class="n">should_reload?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Confusingly, we flip the request prepare/cleanup life cycle around so that we're only cleaning up on those
requests that want to be reloaded</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">processed_a_request?</span> <span class="c1"># No-op if this is the first request.  The initializers take care of that one.</span>
        <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Reloader</span><span class="o">.</span><span class="n">cleanup!</span>
        <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Reloader</span><span class="o">.</span><span class="n">prepare!</span>
      <span class="k">end</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">processed_a_request</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="k">elsif</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dev_tweaks</span><span class="o">.</span><span class="n">log_autoload_notice</span>
      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s1">&#39;RailsDevTweaks: Skipping ActionDispatch::Reloader hooks for this request.&#39;</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></div></div></div></div></body></html>